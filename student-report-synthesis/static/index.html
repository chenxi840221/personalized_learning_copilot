<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Report Synthesis System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.5/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100" x-data="app()">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-blue-800">Student Report Synthesis System</h1>
        <p class="text-center text-gray-600 mb-8">Generate standardized student reports following Australian education guidelines</p>
        
        <!-- Status Messages -->
        <div x-show="statusMessage" :class="statusSuccess ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700'" class="border px-4 py-3 rounded relative mb-6">
            <span x-text="statusMessage"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3" @click="statusMessage = ''">
                <svg class="fill-current h-6 w-6" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <title>Close</title>
                    <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                </svg>
            </span>
        </div>
        
        <!-- System Status -->
        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-8">
            <div class="flex items-center">
                <div class="mr-2">
                    <svg class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <div>
                    <p class="font-bold">System Status</p>
                    <p class="text-sm" x-text="systemStatus"></p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6">
            <ul class="flex border-b">
                <li class="-mb-px mr-1" @click="activeTab = 'upload'">
                    <a :class="activeTab === 'upload' ? 'border-l border-t border-r rounded-t bg-white text-blue-700' : 'text-blue-500 hover:text-blue-800'" class="inline-block py-2 px-4 font-semibold" href="#">
                        1. Upload Templates
                    </a>
                </li>
                <li class="mr-1" @click="activeTab = 'generate'">
                    <a :class="activeTab === 'generate' ? 'border-l border-t border-r rounded-t bg-white text-blue-700' : 'text-blue-500 hover:text-blue-800'" class="inline-block py-2 px-4 font-semibold" href="#">
                        2. Generate Reports
                    </a>
                </li>
                <li class="mr-1" @click="activeTab = 'download'">
                    <a :class="activeTab === 'download' ? 'border-l border-t border-r rounded-t bg-white text-blue-700' : 'text-blue-500 hover:text-blue-800'" class="inline-block py-2 px-4 font-semibold" href="#">
                        3. Download Reports
                    </a>
                </li>
            </ul>
        </div>

        <!-- Upload Template Tab -->
        <div x-show="activeTab === 'upload'" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">Upload Report Templates</h2>
            <form @submit.prevent="uploadTemplate" class="space-y-4">
                <div>
                    <label for="templateName" class="block text-gray-700 font-bold mb-2">Template Name</label>
                    <input type="text" id="templateName" x-model="templateName" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="templateFile" class="block text-gray-700 font-bold mb-2">Template PDF or Word Document</label>
                    <input type="file" id="templateFile" @change="handleFileSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md" accept=".pdf,.doc,.docx" required>
                    <p class="text-sm text-gray-500 mt-1">Supported formats: PDF, DOC, DOCX</p>
                </div>
                <div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Upload Template
                    </button>
                </div>
            </form>

            <div class="mt-8">
                <h3 class="text-lg font-bold mb-4">Available Templates</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Name
                                </th>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Date
                                </th>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-if="templates.length === 0">
                                <tr>
                                    <td colspan="4" class="py-4 px-6 border-b border-gray-200 text-center">
                                        No templates available. Please upload a template first.
                                    </td>
                                </tr>
                            </template>
                            <template x-for="template in templates" :key="template.id">
                                <tr>
                                    <td class="py-2 px-4 border-b border-gray-200" x-text="template.name"></td>
                                    <td class="py-2 px-4 border-b border-gray-200">
                                        <span :class="template.status === 'ready' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" class="px-2 py-1 rounded-full text-xs" x-text="template.status"></span>
                                    </td>
                                    <td class="py-2 px-4 border-b border-gray-200" x-text="formatDate(template.upload_date)"></td>
                                    <td class="py-2 px-4 border-b border-gray-200">
                                        <button @click="selectTemplate(template)" class="bg-blue-500 hover:bg-blue-700 text-white text-xs py-1 px-2 rounded">
                                            Select
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Generate Reports Tab -->
        <div x-show="activeTab === 'generate'" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">Generate Student Reports</h2>
            
            <div x-show="!selectedTemplate.id" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                <p>Please select a template first from the "Upload Templates" tab.</p>
            </div>
            
            <div x-show="selectedTemplate.id">
                <div class="mb-4">
                    <p class="text-gray-700">Selected Template: <span class="font-bold" x-text="selectedTemplate.name"></span></p>
                </div>
                
                <form @submit.prevent="generateReports" class="space-y-4">
                    <div>
                        <label for="numReports" class="block text-gray-700 font-bold mb-2">Number of Reports</label>
                        <input type="number" id="numReports" x-model="numReports" min="1" max="20" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        <p class="text-sm text-gray-500 mt-1">Generate between 1 and 20 reports</p>
                    </div>
                    <div>
                        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                            Generate Reports
                        </button>
                    </div>
                </form>
                
                <div class="mt-8" x-show="batches.length > 0">
                    <h3 class="text-lg font-bold mb-4">Generated Report Batches</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                        Batch ID
                                    </th>
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                        Template
                                    </th>
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                        Reports
                                    </th>
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                        Status
                                    </th>
                                    <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="batch in batches" :key="batch.batch_id">
                                    <tr>
                                        <td class="py-2 px-4 border-b border-gray-200" x-text="batch.batch_id"></td>
                                        <td class="py-2 px-4 border-b border-gray-200" x-text="batch.template_name"></td>
                                        <td class="py-2 px-4 border-b border-gray-200" x-text="batch.num_reports"></td>
                                        <td class="py-2 px-4 border-b border-gray-200">
                                            <span :class="batch.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" class="px-2 py-1 rounded-full text-xs" x-text="batch.status"></span>
                                        </td>
                                        <td class="py-2 px-4 border-b border-gray-200">
                                            <button @click="viewBatch(batch)" class="bg-blue-500 hover:bg-blue-700 text-white text-xs py-1 px-2 rounded">
                                                View
                                            </button>
                                            <button @click="downloadAllReports(batch.batch_id)" class="bg-green-500 hover:bg-green-700 text-white text-xs py-1 px-2 rounded ml-2">
                                                Download All
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Download Reports Tab -->
        <div x-show="activeTab === 'download'" class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4">Download Student Reports</h2>
            
            <div x-show="!selectedBatch.batch_id" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                <p>No batch selected. Please go to the "Generate Reports" tab to select a batch.</p>
            </div>
            
            <div x-show="selectedBatch.batch_id">
                <div class="mb-4">
                    <p class="text-gray-700">Batch ID: <span class="font-bold" x-text="selectedBatch.batch_id"></span></p>
                    <p class="text-gray-700">Template: <span class="font-bold" x-text="selectedBatch.template_name"></span></p>
                    <p class="text-gray-700">Status: 
                        <span :class="selectedBatch.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" class="px-2 py-1 rounded-full text-xs" x-text="selectedBatch.status"></span>
                    </p>
                </div>
                
                <div class="flex justify-end mb-4">
                    <button @click="downloadAllReports(selectedBatch.batch_id)" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                        Download All Reports
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead>
                            <tr>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Report ID
                                </th>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Student Name
                                </th>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Status
                                </th>
                                <th class="py-2 px-4 border-b border-gray-200 bg-gray-50 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                    Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="report in selectedBatch.reports || []" :key="report.id">
                                <tr>
                                    <td class="py-2 px-4 border-b border-gray-200" x-text="report.id"></td>
                                    <td class="py-2 px-4 border-b border-gray-200" x-text="report.student_name || 'Unnamed Student'"></td>
                                    <td class="py-2 px-4 border-b border-gray-200">
                                        <span :class="report.status === 'generated' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 py-1 rounded-full text-xs" x-text="report.status"></span>
                                    </td>
                                    <td class="py-2 px-4 border-b border-gray-200">
                                        <button x-show="report.status === 'generated'" @click="downloadReport(selectedBatch.batch_id, report.id)" class="bg-blue-500 hover:bg-blue-700 text-white text-xs py-1 px-2 rounded">
                                            Download
                                        </button>
                                        <span x-show="report.status !== 'generated'" class="text-gray-500 text-xs">Not available</span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        function app() {
            return {
                activeTab: 'upload',
                statusMessage: '',
                statusSuccess: true,
                systemStatus: 'Checking system status...',
                templateName: '',
                templateFile: null,
                templates: [], // Explicitly initialize as an empty array
                selectedTemplate: {},
                numReports: 5,
                batches: [], // Explicitly initialize as an empty array
                selectedBatch: { reports: [] }, // Initialize with an empty reports array
                
                init() {
                    this.checkSystemHealth();
                    this.loadTemplates();
                },
                
                async checkSystemHealth() {
                    try {
                        const response = await fetch('/health');
                        const data = await response.json();
                        
                        if (data.status === 'healthy') {
                            this.systemStatus = 'System is operational';
                        } else {
                            this.systemStatus = 'System is partially operational. Some features may be limited.';
                        }
                    } catch (error) {
                        this.systemStatus = 'System status check failed. Some features may be unavailable.';
                        console.error('Health check failed:', error);
                    }
                },
                
                handleFileSelect(event) {
                    this.templateFile = event.target.files[0];
                },
                
                async uploadTemplate() {
                    if (!this.templateName || !this.templateFile) {
                        this.showError('Please provide a template name and file');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('template_name', this.templateName);
                    formData.append('template_file', this.templateFile);
                    
                    try {
                        const response = await fetch('/templates/upload/', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.showSuccess('Template uploaded successfully');
                            this.templateName = '';
                            document.getElementById('templateFile').value = '';
                            this.templateFile = null;
                            // Reload templates after successful upload
                            await this.loadTemplates();
                        } else {
                            const errorData = await response.json();
                            this.showError(`Failed to upload template: ${errorData.detail}`);
                        }
                    } catch (error) {
                        this.showError('Failed to upload template: Network error');
                        console.error('Upload error:', error);
                    }
                },
                
                async loadTemplates() {
                    try {
                        const response = await fetch('/templates/');
                        if (response.ok) {
                            const data = await response.json();
                            // Ensure templates is always an array
                            this.templates = Array.isArray(data.templates) ? data.templates : [];
                            console.log('Templates loaded:', this.templates);
                        } else {
                            console.error('Failed to load templates');
                            this.templates = []; // Reset to empty array on error
                        }
                    } catch (error) {
                        console.error('Error loading templates:', error);
                        this.templates = []; // Reset to empty array on error
                    }
                },
                
                selectTemplate(template) {
                    this.selectedTemplate = template || {};
                    if (template && template.name) {
                        this.showSuccess(`Template "${template.name}" selected`);
                        this.activeTab = 'generate';
                    }
                },
                
                async generateReports() {
                    if (!this.selectedTemplate.id) {
                        this.showError('Please select a template first');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('template_id', this.selectedTemplate.id);
                    formData.append('num_reports', this.numReports);
                    
                    try {
                        const response = await fetch('/reports/generate/', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.showSuccess(`Started generating ${this.numReports} reports`);
                            
                            // Add the new batch to our list
                            if (data.batch_id) {
                                // Initialize batches array if needed
                                if (!Array.isArray(this.batches)) {
                                    this.batches = [];
                                }
                                
                                // Wait a moment to ensure report generation has started
                                setTimeout(() => this.checkBatchStatus(data.batch_id), 1000);
                            }
                        } else {
                            const errorData = await response.json();
                            this.showError(`Failed to generate reports: ${errorData.detail}`);
                        }
                    } catch (error) {
                        this.showError('Failed to generate reports: Network error');
                        console.error('Generation error:', error);
                    }
                },
                
                async checkBatchStatus(batchId) {
                    try {
                        const response = await fetch(`/reports/status/${batchId}/`);
                        if (response.ok) {
                            const data = await response.json();
                            
                            // Initialize batches array if needed
                            if (!Array.isArray(this.batches)) {
                                this.batches = [];
                            }
                            
                            // Add or update batch in our list
                            const existingIndex = this.batches.findIndex(b => b.batch_id === batchId);
                            if (existingIndex >= 0) {
                                this.batches[existingIndex] = data;
                            } else {
                                this.batches.push(data);
                            }
                            
                            // If still processing, check again in a moment
                            if (data.status === 'processing') {
                                setTimeout(() => this.checkBatchStatus(batchId), 2000);
                            } else if (data.status === 'completed') {
                                this.showSuccess(`Reports generated successfully`);
                            }
                        }
                    } catch (error) {
                        console.error('Error checking batch status:', error);
                    }
                },
                
                viewBatch(batch) {
                    // Ensure batch has a reports array
                    if (batch && !Array.isArray(batch.reports)) {
                        batch.reports = [];
                    }
                    this.selectedBatch = batch || { reports: [] };
                    this.activeTab = 'download';
                },
                
                downloadReport(batchId, reportId) {
                    if (batchId && reportId) {
                        window.open(`/reports/${batchId}/${reportId}/download/`, '_blank');
                    }
                },
                
                downloadAllReports(batchId) {
                    if (batchId) {
                        window.open(`/reports/${batchId}/download-all/`, '_blank');
                    }
                },
                
                showSuccess(message) {
                    if (message) {
                        this.statusMessage = message;
                        this.statusSuccess = true;
                        setTimeout(() => this.statusMessage = '', 5000);
                    }
                },
                
                showError(message) {
                    if (message) {
                        this.statusMessage = message;
                        this.statusSuccess = false;
                        setTimeout(() => this.statusMessage = '', 8000);
                    }
                },
                
                formatDate(dateString) {
                    if (!dateString) return 'Unknown';
                    try {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('en-AU', { year: 'numeric', month: 'short', day: 'numeric' });
                    } catch (error) {
                        return 'Invalid date';
                    }
                }
            };
        }
    </script>
</body>
</html>